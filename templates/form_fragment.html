{% set show_duration_controls = true %}
<form hx-post="/generate/{{ schema }}" hx-target="#result" class="space-y-4">
  <input type="hidden" name="schema" value="{{ schema }}" />

  {% if schema == "mman" %}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    {% for label, name in [ ("Morgens", "morning"), ("Mittags", "noon"), ("Abends", "evening"), ("Nachts", "night") ] %}
    <label class="block">
      {{ label }}:
      <input type="number" name="{{ name }}" min="0" class="w-full border rounded px-2 py-1" />
    </label>
    {% endfor %}
  </div>

  {% elif schema == "timeofday" %}
  <div id="timeofday-inputs" class="space-y-2">
    <div class="grid grid-cols-2 gap-2">
      <input type="time" name="time_1" class="w-full border rounded px-2 py-1" required />
      <input type="number" name="dose_1" step="any" min="0" class="w-full border rounded px-2 py-1" required placeholder="Dosis" />
    </div>
  </div>
  <button type="button" onclick="addTimeOfDayField()" class="text-blue-600 hover:underline text-sm">+ Weitere Uhrzeit hinzufügen</button>

  <script>
    let timeOfDayCount = 1;
    function addTimeOfDayField() {
      timeOfDayCount++;
      const container = document.getElementById("timeofday-inputs");
      const div = document.createElement("div");
      div.className = "grid grid-cols-2 gap-2";
      div.innerHTML = `
        <input type="time" name="time_${timeOfDayCount}" class="w-full border rounded px-2 py-1" required />
        <input type="number" name="dose_${timeOfDayCount}" step="any" min="0" class="w-full border rounded px-2 py-1" required placeholder="Dosis" />
      `;
      container.appendChild(div);
    }
  </script>

  {% elif schema == "weekday" %}
  <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
    {% for day in ["mon", "tue", "wed", "thu", "fri", "sat", "sun"] %}
    <label class="flex items-center gap-2">
      <input type="checkbox" name="day_{{ day }}" value="1" class="rounded border" />
      {{ day|title }}:
      <input type="number" name="dose_{{ day }}" min="0" step="any" class="w-20 border rounded px-2 py-1" placeholder="Dosis" />
    </label>
    {% endfor %}
  </div>

  {% elif schema == "interval" %}
  <label class="block">
    Häufigkeit (frequency):
    <input type="number" name="frequency" min="1" class="w-full border rounded px-2 py-1" required />
  </label>
  <label class="block">
    Intervall (period):
    <input type="number" name="period" min="1" class="w-full border rounded px-2 py-1" required />
  </label>
  <label class="block">
    Zeiteinheit:
    <select name="period_unit" class="w-full border rounded px-2 py-1" required>
      <option value="d">Tage</option>
      <option value="wk">Wochen</option>
      <option value="mo">Monate</option>
    </select>
  </label>
  <label class="block">
    Dosis:
    <input type="number" name="dose" step="any" min="0.1" class="w-full border rounded px-2 py-1" />
  </label>

  {% elif schema in ["combined_interval_time", "weekday_combined"] %}
  {% for i in range(1, 4) %}
  <fieldset class="border p-3 rounded">
    <legend class="font-semibold text-sm mb-2">Zeitpunkt {{ i }}</legend>
    {% if schema == "weekday_combined" %}
    <label class="block mb-2">
      Wochentage:
      <select name="days{{ i }}" multiple class="w-full border rounded px-2 py-1">
        {% for d in ["mon", "tue", "wed", "thu", "fri", "sat", "sun"] %}
        <option value="{{ d }}">{{ d|title }}</option>
        {% endfor %}
      </select>
    </label>
    {% endif %}
    <label class="block mb-2">
      Tageszeit:
      <select name="when{{ i }}" class="w-full border rounded px-2 py-1">
        <option value="">–</option>
        <option value="MORN">Morgens</option>
        <option value="NOON">Mittags</option>
        <option value="EVE">Abends</option>
        <option value="NIGHT">Nachts</option>
      </select>
    </label>
    <label class="block mb-2">
      Alternativ: Uhrzeit:
      <input type="time" name="time{{ i }}" class="w-full border rounded px-2 py-1" />
    </label>
    <label class="block">
      Dosis:
      <input type="number" step="any" name="dose{{ i }}" class="w-full border rounded px-2 py-1" />
    </label>
  </fieldset>
  {% endfor %}

{% else %}
<form hx-post="/generate/freetext" hx-target="#result" class="space-y-4">
  <input type="hidden" name="schema" value="freetext" />

  <label class="block">
    Freitext-Dosierung:
    <input type="text" name="freetext" class="w-full border rounded px-2 py-1" />
  </label>
  {% endif %}

  <!-- Globale Felder
  <label class="block">
    Arzneimittel:
    <input type="text" name="medication" value="Arzneimittel" class="w-full border rounded px-2 py-1" required />
  </label>

  <label class="block">
    Einheit:
    <input type="text" name="unit" value="Stück" class="w-full border rounded px-2 py-1" required />
  </label>
   -->
  {% if schema != "freetext" %}
  <label class="block">
    <input type="checkbox" id="limit_duration" onclick="toggleDuration()" class="mr-2" />
    Einnahmedauer zeitlich einschränken
  </label>
  <div id="duration_fields" class="hidden">
    <div class="flex gap-2">
      <input type="number" name="duration_value" min="1" class="w-24 border rounded px-2 py-1" placeholder="z. B. 10" />
      <select name="duration_unit" class="border rounded px-2 py-1">
        <option value="d">Tage</option>
        <option value="wk">Wochen</option>
        <option value="mo">Monate</option>
      </select>
    </div>
  </div>
  <script>
    function toggleDuration() {
      const box = document.getElementById("limit_duration");
      const fields = document.getElementById("duration_fields");
      fields.classList.toggle("hidden", !box.checked);
    }
  </script>
 {% endif %}
  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
    Dosierung generieren
  </button>
</form>