{% set show_duration_controls = true %}
<form hx-post="/generate/{{ schema }}" hx-target="#result" class="space-y-4">
  <input type="hidden" name="schema" value="{{ schema }}" />

  {% macro mman_fields(prefix="") %}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    {% for label, name in [("Morgens", "morning"), ("Mittags", "noon"), ("Abends", "evening"), ("Nachts", "night")] %}
    <label class="block">
      {{ label }}:
      <input type="number" name="{{ prefix }}{{ name }}" min="0" class="w-full border rounded px-2 py-1" />
    </label>
    {% endfor %}
  </div>
  {% endmacro %}

  {% macro timeofday_fields(index="1") %}
  <div class="grid grid-cols-2 gap-2">
    <input type="time" name="time_{{ index }}" class="w-full border rounded px-2 py-1" required />
    <input type="number" name="dose_{{ index }}" step="any" min="0" class="w-full border rounded px-2 py-1" required placeholder="Dosis" />
  </div>
  {% endmacro %}

  {% if schema == "mman" %}
    {{ mman_fields() }}

    {% elif schema == "timeofday" %}
    <div id="timeofday-inputs" class="space-y-2">
    <div class="grid grid-cols-2 gap-2">
        <input type="time" name="time_1" class="w-full border rounded px-2 py-1 time-input" required />
        <input type="number" name="dose_1" step="any" min="0" class="w-full border rounded px-2 py-1" required placeholder="Dosis" />
    </div>
    </div>

    <p id="duplicate-warning" class="text-red-600 text-sm hidden mt-1">Uhrzeiten dürfen nicht doppelt vergeben werden.</p>

    <button type="button" onclick="addTimeOfDayField()" class="text-blue-600 hover:underline text-sm mt-2">
    + Weitere Uhrzeit hinzufügen
    </button>

    <script>
    let timeOfDayCount = 1;

    function validateDuplicateTimes() {
        const inputs = document.querySelectorAll('.time-input');
        const seen = new Set();
        let duplicate = false;

        inputs.forEach(input => {
        const val = input.value;
        if (!val) {
            input.classList.remove("border-red-500");
            return;
        }

        if (seen.has(val)) {
            input.classList.add("border-red-500");
            duplicate = true;
        } else {
            seen.add(val);
            input.classList.remove("border-red-500");
        }
        });

        document.getElementById("duplicate-warning").classList.toggle("hidden", !duplicate);
    }

    function attachValidation(input) {
        input.addEventListener("input", validateDuplicateTimes);
    }

    function addTimeOfDayField() {
        timeOfDayCount++;
        const container = document.getElementById("timeofday-inputs");
        const div = document.createElement("div");
        div.className = "grid grid-cols-2 gap-2";
        div.innerHTML = `
        <input type="time" name="time_${timeOfDayCount}" class="w-full border rounded px-2 py-1 time-input" required />
        <input type="number" name="dose_${timeOfDayCount}" step="any" min="0" class="w-full border rounded px-2 py-1" required placeholder="Dosis" />
        `;
        container.appendChild(div);

        // neue Zeitinput-Felder validieren
        const newInput = div.querySelector('.time-input');
        attachValidation(newInput);
    }

    // initiales Feld anhängen
    document.querySelectorAll('.time-input').forEach(attachValidation);
    </script>

    {% elif schema == "weekday" %}
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
    {% set days = [
        ("mon", "Mo"), ("tue", "Di"), ("wed", "Mi"),
        ("thu", "Do"), ("fri", "Fr"), ("sat", "Sa"), ("sun", "So")
    ] %}
    {% for code, label in days %}
    <label class="flex items-center gap-2">
        {{ label }}:
        <input type="number" name="dose_{{ code }}" min="0" step="any" class="w-20 border rounded px-2 py-1" placeholder="Dosis" />
    </label>
    {% endfor %}
    </div>

  {% elif schema == "interval" %}
  <label class="block">
    Häufigkeit (frequency):
    <input type="number" name="frequency" min="1" class="w-full border rounded px-2 py-1" required />
  </label>
  <label class="block">
    Intervall (period):
    <input type="number" name="period" min="1" class="w-full border rounded px-2 py-1" required />
  </label>
  <label class="block">
    Zeiteinheit:
    <select name="period_unit" class="w-full border rounded px-2 py-1" required>
        <option value="d">Tag(e)</option>
        <option value="wk">Woche(n)</option>
        <option value="mo">Monat(e)</option>
        <option value="a">Jahr(e)</option>
    </select>
  </label>
  <label class="block">
    Dosis:
    <input type="number" name="dose" step="any" min="0.1" class="w-full border rounded px-2 py-1" />
  </label>

  {% elif schema in ["combined_interval_time", "weekday_combined"] %}
  <div id="combo-fields">
    <!-- Initial block -->
  </div>
  <button type="button" onclick="addComboField()" class="text-blue-600 hover:underline text-sm">+ Zeitpunkt hinzufügen</button>

  {% if schema == "combined_interval_time" %}
  <label class="block mt-4">
    Häufigkeit (frequency):
    <input type="number" name="frequency" min="1" class="w-full border rounded px-2 py-1" />
  </label>
  <label class="block">
    Intervall (period):
    <input type="number" name="period" min="1" class="w-full border rounded px-2 py-1" />
  </label>
    <label class="block">
    Zeiteinheit:
    <select name="period_unit" class="w-full border rounded px-2 py-1">
        <option value="d">Tag(e)</option>
        <option value="wk">Woche(n)</option>
        <option value="mo">Monat(e)</option>
        <option value="a">Jahr(e)</option>
    </select>
    </label>
  {% endif %}

  <script>
    let comboIndex = 0;
    function addComboField() {
      comboIndex++;
      const container = document.getElementById("combo-fields");
      const wrapper = document.createElement("fieldset");
      wrapper.className = "border p-3 rounded mb-4";
      wrapper.innerHTML = `
        <legend class="font-semibold text-sm mb-2">Zeitpunkt ${comboIndex}</legend>
        {% if schema == "weekday_combined" %}
        <label class="block mb-2">
          Wochentage:
          <select name="days_${comboIndex}" multiple class="w-full border rounded px-2 py-1">
            {% for d in ["mon", "tue", "wed", "thu", "fri", "sat", "sun"] %}
            <option value="{{ d }}">{{ d|title }}</option>
            {% endfor %}
          </select>
        </label>
        {% endif %}
        <label class="block mb-2">
          Eingabemodus:
          <select name="mode_${comboIndex}" class="w-full border rounded px-2 py-1" onchange="toggleTimeMode(this, ${comboIndex})">
            <option value="mman">Tageszeit (MMAN)</option>
            <option value="timeofday">Uhrzeit</option>
          </select>
        </label>
        <div id="time-fields-${comboIndex}">
          {{ mman_fields("${comboIndex}_") }}
        </div>
        <label class="block">
          Dosis:
          <input type="number" step="any" name="dose_${comboIndex}" class="w-full border rounded px-2 py-1" />
        </label>
      `;
      container.appendChild(wrapper);
    }
    function toggleTimeMode(select, index) {
      const target = document.getElementById(`time-fields-${index}`);
      if (select.value === 'timeofday') {
        target.innerHTML = `
          <div class='grid grid-cols-2 gap-2'>
            <input type='time' name='time_${index}' class='w-full border rounded px-2 py-1' required />
            <input type='number' name='dose_${index}' step='any' min='0' class='w-full border rounded px-2 py-1' required placeholder='Dosis' />
          </div>
        `;
      } else {
        target.innerHTML = `
          <div class='grid grid-cols-2 md:grid-cols-4 gap-4'>
            <label class='block'>Morgens:<input type='number' name='${index}_morning' min='0' class='w-full border rounded px-2 py-1' /></label>
            <label class='block'>Mittags:<input type='number' name='${index}_noon' min='0' class='w-full border rounded px-2 py-1' /></label>
            <label class='block'>Abends:<input type='number' name='${index}_evening' min='0' class='w-full border rounded px-2 py-1' /></label>
            <label class='block'>Nachts:<input type='number' name='${index}_night' min='0' class='w-full border rounded px-2 py-1' /></label>
          </div>
        `;
      }
    }
  </script>

  {% else %}
  <label class="block">
    Freitext-Dosierung:
    <input type="text" name="freetext" class="w-full border rounded px-2 py-1" />
  </label>
  {% endif %}

{% if schema != "freetext" %}
  <label class="block">
    <input type="checkbox" id="limit_duration" onclick="toggleDuration()" class="mr-2" />
    Einnahmedauer zeitlich einschränken
  </label>
  <div id="duration_fields" class="hidden">
    <div class="flex gap-2">
      <input type="number" name="duration_value" min="1" class="w-24 border rounded px-2 py-1" placeholder="z. B. 10" />
      <select name="duration_unit" class="border rounded px-2 py-1">
        <option value="d">Tag(e)</option>
        <option value="wk">Woche(n)</option>
        <option value="mo">Monat(e)</option>
        <option value="a">Jahr(e)</option>
      </select>
    </div>
  </div>
  <script>
    function toggleDuration() {
      const box = document.getElementById("limit_duration");
      const fields = document.getElementById("duration_fields");
      fields.classList.toggle("hidden", !box.checked);
    }
  </script>
{% endif %}

  <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
    Dosierung generieren
  </button>
</form>